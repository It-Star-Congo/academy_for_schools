<!-- ====== HEAD (mets ça dans <head>) ====== -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet">
<style>
  /* Container */
  .calendar-wrap { max-width: 1100px; margin: 30px auto; padding: 0 16px; }

  /* Bouton d’ajout */
  .cal-actions { display:flex; justify-content:flex-end; margin: 0 0 12px; }
  .btn {
    display:inline-flex; align-items:center; gap:8px;
    padding:10px 14px; border-radius:10px; border:1px solid #e6e6e6;
    background:#fff; font-weight:700; cursor:pointer; transition: box-shadow .2s;
  }
  .btn:hover { box-shadow: 0 6px 14px rgba(0,0,0,.07); }

  /* Modal */
  .modal-backdrop {
    position:absolute; inset:0; background:rgba(0,0,0,.45);
    display:none; align-items:center; justify-content:center; z-index: 9999;
    height:auto; margin-top: 25%;
  }
  .modal {
    width:min(560px, 92vw); background:#fff; border-radius:14px; overflow:hidden;
    box-shadow: 0 20px 50px rgba(0,0,0,.2);
  }
  .modal__header { padding:14px 16px; background:#002147; color:#ffcc00; font-weight:800; }
  .modal__body { padding:16px; display:grid; gap:12px; }
  .modal__footer { padding:12px 16px; display:flex; gap:10px; justify-content:flex-end; background:#fafafa; }
  .field { display:grid; gap:6px; }
  .field label { font-weight:700; font-size:.95rem; color:#002147; }
  .field input, .field select, .field textarea {
    width:100%; padding:10px 12px; border-radius:10px; border:1px solid #d9d9d9; outline:none;
  }
  .field textarea { resize:vertical; min-height:80px; }
  .btn.primary { background:linear-gradient(90deg,#ffcc00,#ffd84a); border-color:#ffcc00; color:#001a33; }
  .btn.ghost { background:#fff; }
  .two-cols { display:grid; gap:10px; grid-template-columns: 1fr 1fr; }
  @media (max-width:620px){ .two-cols { grid-template-columns: 1fr; } }
</style>

<!-- ====== BODY (mets ça dans ton <body>) ====== -->
<div class="calendar-wrap">
  <div class="cal-actions">
    <button id="btn-new" class="btn">➕ Nouvel événement</button>
  </div>
  <div id="calendar"></div>
</div>

<!-- Modal création/édition -->
<div class="modal-backdrop" id="modal">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div class="modal__header"><span id="modal-title">Ajouter un événement</span></div>
    <div class="modal__body">
      <div class="field">
        <label for="ev-title">Titre</label>
        <input id="ev-title" type="text" placeholder="Ex: Cours Réseaux – Chapitre 3" required>
      </div>

      <div class="two-cols">
        <div class="field">
          <label for="ev-type">Type</label>
          <select id="ev-type">
            <option value="cours">Cours</option>
            <option value="devoir">Devoir</option>
            <option value="examen">Examen</option>
            <option value="evenement">Événement</option>
          </select>
        </div>
        <div class="field">
          <label for="ev-importance">Importance</label>
          <select id="ev-importance">
            <option value="low">Faible</option>
            <option value="normal" selected>Normale</option>
            <option value="high">Élevée</option>
            <option value="urgent">Urgente</option>
          </select>
        </div>
      </div>

      <div class="two-cols">
        <div class="field">
          <label for="ev-start">Début</label>
          <input id="ev-start" type="datetime-local" required>
        </div>
        <div class="field">
          <label for="ev-end">Fin</label>
          <input id="ev-end" type="datetime-local">
        </div>
      </div>

      <div class="field">
        <label for="ev-location">Lieu</label>
        <input id="ev-location" type="text" placeholder="Ex: Auditoire H1302">
      </div>
      
      <!-- Dans le modal, remplace ton champ "Classe(s) concernée(s)" -->
        <div class="field">
        <label for="ev-classes">Classe(s) concernée(s)</label>
        <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">
            <label><input type="checkbox" id="ev-all-classes"> Toutes les classes</label>
        </div>
        <select id="ev-classes" multiple size="6" style="width:100%; padding:10px; border-radius:10px; border:1px solid #d9d9d9;">
            <!-- Options injectées par JS -->
        </select>
        <small>Astuce: Ctrl/Cmd + clic pour multi-sélection.</small>
        </div>


      <div class="field">
        <label for="ev-desc">Description</label>
        <textarea id="ev-desc" placeholder="Infos complémentaires…"></textarea>
      </div>

      <div class="field">
        <label><input id="ev-notify" type="checkbox" checked> Notifier les élèves (quand on branchera le backend)</label>
      </div>
    </div>
    <div class="modal__footer">
      <button class="btn primary" id="btn-cancel">Annuler</button>
      <button class="btn primary" id="btn-save">Enregistrer</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
<script>

  // ====== Helpers modal ======
  const modal = document.getElementById('modal');
  const openModal = () => modal.style.display = 'flex';
  const closeModal = () => { modal.style.display = 'none'; editingId = null; }

  // Références champ
  const f = {
    title: document.getElementById('ev-title'),
    type: document.getElementById('ev-type'),
    importance: document.getElementById('ev-importance'),
    start: document.getElementById('ev-start'),
    end: document.getElementById('ev-end'),
    loc: document.getElementById('ev-location'),
    desc: document.getElementById('ev-desc'),
    notify: document.getElementById('ev-notify')
  };

  console.log('c est iciiiii');

  

  const clsSelect = document.getElementById('ev-classes');
  const allClassesCbx = document.getElementById('ev-all-classes');

  async function loadClasses() {
    try {
        const r = await fetch('/admin/api/classes', { credentials:'include' });
        const classes = await r.json();
        console.log(classes);
        clsSelect.innerHTML = '';
        for (const c of classes) {
            const opt = document.createElement('option');
            opt.value = String(c.id);
            opt.textContent = c.name;
            clsSelect.appendChild(opt);
        }
    } catch (e) {
        console.error(e);
        // Fallback: pas de classes -> on affiche quand même le calendrier
        clsSelect.innerHTML = '';
    }
  }

  allClassesCbx.addEventListener('change', () => {
    const all = allClassesCbx.checked;
    for (const opt of clsSelect.options) opt.selected = all;
    clsSelect.disabled = all;
  });

    function getSelectedClassIds() {
    return Array.from(clsSelect.selectedOptions).map(o => parseInt(o.value, 10));
    }
    function setSelectedClassIds(ids) {
    const set = new Set((ids || []).map(x => String(x)));
    let count = 0;
    for (const opt of clsSelect.options) {
        opt.selected = set.has(opt.value);
        if (opt.selected) count++;
    }
    const allSelected = count > 0 && count === clsSelect.options.length;
    allClassesCbx.checked = allSelected;
    clsSelect.disabled = allSelected;
    }


  // ====== Init FullCalendar ======
  let editingId = null; // pour édition
  document.addEventListener('DOMContentLoaded', async function() {
    await loadClasses();
    const calendarEl = document.getElementById('calendar');
    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      locale: 'fr',
      timeZone: 'local',
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek,listWeek'
      },
      eventDisplay: 'block',
      events: async (fetchInfo, success, failure) => {
        try {
          const qs = new URLSearchParams({
            start: fetchInfo.startStr,
            end: fetchInfo.endStr
          });
          const r = await fetch(`/admin/calendar/events?${qs.toString()}`, { credentials:'include' });
          const data = await r.json();
          success(data.map(e => ({
            id: e.id,
            title: e.title,
            start: e.startDate,
            end: e.endDate || null,
            extendedProps: { fullData: e },
            backgroundColor: colorFor(e),
            borderColor: colorFor(e),
          })));
        } catch (err) { failure(err); }
      },
      selectable: true,
      select: (info) => {
        // Pré-remplir start/end
        f.start.value = toLocal(info.start);
        f.end.value = info.end ? toLocal(info.end) : '';
        f.title.value = ''; f.desc.value = ''; f.loc.value = '';
        f.type.value = 'cours'; f.importance.value='normal'; f.notify.checked = true;
        editingId = null;
        document.getElementById('modal-title').textContent = 'Ajouter un événement';
        openModal();
      },
      eventClick: (info) => {
        const ev = info.event.extendedProps.fullData || {};
        editingId = info.event.id;
        document.getElementById('modal-title').textContent = 'Modifier l’événement';
        f.title.value = info.event.title || '';
        f.type.value = ev.type || 'evenement';
        f.importance.value = ev.importance || 'normal';
        f.start.value = toLocal(info.event.start);
        f.end.value = info.event.end ? toLocal(info.event.end) : '';
        f.loc.value = ev.location || '';
        f.desc.value = ev.description || '';
        f.notify.checked = ev.notify ?? true;
        openModal();
      },
    });

    calendar.render();

    // Bouton "nouvel événement"
    document.getElementById('btn-new').addEventListener('click', () => {
      editingId = null;
      document.getElementById('modal-title').textContent = 'Ajouter un événement';
      f.title.value=''; f.desc.value=''; f.loc.value='';
      f.type.value='cours'; f.importance.value='normal'; f.notify.checked=true;
      f.start.value = ''; f.end.value = '';
      openModal();
    });

    // Actions modal
    document.getElementById('btn-cancel').addEventListener('click', closeModal);
    modal.addEventListener('click', (e)=> { if(e.target === modal) closeModal(); });

        document.getElementById('btn-save').addEventListener('click', async () => {
      if (!f.title.value || !f.start.value) { alert('Titre et date de début requis.'); return; }
      console.log("hola");
      console.log(f.title.value, f.type.value, f.importance.value, f.start.value, f.end.value, f.loc.value, f.desc.value, f.notify.value);

      const payload = {
        title: f.title.value.trim(),
        type: f.type.value,                    // 'lecture' | 'assignment' | 'exam' | 'event'
        importance: f.importance.value,        // 'low' | 'normal' | 'high' | 'urgent'
        startDate: fromLocal(f.start.value),
        endDate: f.end.value ? fromLocal(f.end.value) : null,
        location: f.loc.value.trim(),
        description: f.desc.value.trim(),
        notify: !!f.notify.checked,            // déclenche ou non les notifications
        // Optionnel: classes ciblées
        classes:  getSelectedClassIds(), //document.getElementById('class').value.trim(), // ex: "L1-Info;L2-Reseaux"
      };

      const isEdit = ! !editingId;
      const url = isEdit ? `/admin/calendar/events/${editingId}` : `/admin/calendar/events`;
      const method = isEdit ? 'PUT' : 'POST';

      console.log(method, url);

      try {
        console.log('ok000');
        const r = await fetch(url, {
          method,
          headers: { 'Content-Type':'application/json' },
          credentials:'include',
          body: JSON.stringify(payload)
        });
        if (!r.ok) throw new Error(await r.text());
        console.log(r);
        await r.json();
        calendar.refetchEvents();
        closeModal();
      } catch (e) {
        console.error(e);

        alert("Échec de l'enregistrement de l'événement.");
      }
    });
  });

  // ====== Utils ======
  function toLocal(d) {
    // date -> 'YYYY-MM-DDTHH:mm' (pour input datetime-local)
    const pad = n => String(n).padStart(2,'0');
    const dt = new Date(d);
    const yyyy = dt.getFullYear();
    const mm = pad(dt.getMonth()+1);
    const dd = pad(dt.getDate());
    const hh = pad(dt.getHours());
    const mi = pad(dt.getMinutes());
    return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
  }
  function fromLocal(s) {
    if (!s || typeof s !== 'string') return null;
    s = s.trim();
    if (!s) return null;
    console.log('s --> ', s);

    // Ajoute les secondes si format "YYYY-MM-DDTHH:mm"
    if (/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}$/.test(s)) {
      s += ":00";
    }

    const d = new Date(s);
    console.log('d --> ', d);
    if (Number.isNaN(d.getTime())) return null;
    const v =  d.toISOString(); // UTC
    console.log('v --> ', d);

    return v
  }

  function colorFor(e){
    // Palette rapide par importance (tu peux customiser)
    const colors = {
      low:    '#9bb7d4',
      normal: '#4db6ac',
      high:   '#ffa726',
      urgent: '#ef5350'
    };
    return colors[e.importance] || '#4db6ac';
    // Tu peux aussi varier par type si tu préfères.
  }
</script>
