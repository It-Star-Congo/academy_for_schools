<section class="profile-container">

    <!-- Section A : Profil -->
    <div class="profile-header">
        <h2><%= user.username %></h2>
        </br>
        <img src="<%= user.profile %>" alt="Photo de profil" class="profile-pic">
        <p><strong>Email :</strong> <%= user.contact %></p>
        <p><strong>Abonnement :</strong> <%= user.abonnement %></p>
    </div>

    <div class="profile-content">
        <!-- Section B : Cours -->
        <div class="courses-container">
            <h3>Mes cours</h3>
            <% userCourses.forEach(course => { %>
                <div class="course-card">
                    Donné par: <%= course.teacher %>
                    <div class="course-info">
                        <h3><%= course.name %></h3>
                        <div class="progress-bar">
                            <div class="progress" style="width: <%= course.progress %>%;"></div>
                        </div>
                        <p><%= course.progress? course.progress : 0 %>% complété</p>
                    </div>
                </div>
            <% }) %>
        </div>

        <!-- Section C : Crédits 
        <div class="credits-section">
            <h3>Classe : <span class="credit-amount"><%= user.credits || "S1A" %></span></h3>
            <a href="/recharge" class="btn">Recharger</a>
        </div>-->

        <!-- Section C : Performances (remplace credits-section) -->
        <div class="credits-section">
        <h3>Performance par cours</h3>

        <div class="chart-wrap" style="width:100%; max-width:320px;">
            <canvas id="coursesChart" aria-label="Graphe des performances par cours" role="img"></canvas>
        </div>

        <div class="chart-summary" style="margin-top:12px; font-size:0.95rem; color:#333;">
            <div id="chart-stats">Calcul des performances…</div>
        </div>

        <div style="margin-top:10px; display:flex; gap:8px; justify-content:center; width:100%;">
            <button id="downloadChart" class="btn" style="padding:8px 12px; font-size:0.9rem;">Télécharger le graphique</button>
            <a href="/recharge" class="btn" style="padding:8px 12px; font-size:0.9rem;">Recharger</a>
        </div>
        </div>
    </div>

    <% if (sessionUser && sessionUser.role === 'admin') { %>
    <!-- Section D : Actions (réservé aux admins) -->
    <div class="actions">
        <a href="/dash/edit-profile/<%= user.id%>/student" class="btn20">Modifier ce profil</a>
        <a href="/delete-account" class="btn btn-delete" onclick="return confirm('Voulez-vous vraiment supprimer cet étudiant ?')">Supprimer ce compte</a>
    </div>
    <% } %>
    <style>

        :root {
        --primary-color: <%= theme.primaryColor %>;
        --secondary-color: <%= theme.secondaryColor %>;
        --font-family: '<%= theme.fontFamily %>';
        }
        .profile-container {
            max-width: 900px;
            margin: 40px auto;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        /* Section A : Profil */
        .profile-header {
            text-align: center;
            padding: 20px;
            border-bottom: 2px solid #ddd;
        }

        .profile-pic {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--primary-color);
        }

        .profile-header h2 {
            margin: 10px 0 5px;
            color:#f3932cd6
        }

        .profile-header p {
            color: #666;
            margin: 5px 0;
        }

        /* Layout principal : Sections B & C en ligne */
        .profile-content {
            display: flex;
            gap: 20px;
            padding: 20px 0;
        }

        /* Section B : Mes cours */
        .courses-container {
            flex: 2;
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            box-shadow: inset 0px 0px 10px rgba(0, 0, 0, 0.05);
            overflow-y: auto; /* Ajout de l'overflow-y pour activer le défilement vertical */
            height: 300px; /* Fixer la hauteur du container */
            border: 2px solid #ddd;
            position : relative;
            scroll-behavior: smooth; /* Défilement fluide */
        }

        .courses-container::-webkit-scrollbar {
            width: 8px;
        }

        .courses-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .courses-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }

        .courses-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .courses-container:hover {
            box-shadow: inset 0px 0px 15px rgba(0, 0, 0, 0.1), 0 6px 12px rgba(0, 0, 0, 0.1); /* Ombre au survol */
            border-color: #bbb;
        }

        /* Card de chaque cours */
        .course-card {
            background: white;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            border: 2px solid var(--primary-color);
            min-height: 150px; /* Assurez-vous que la card a une hauteur minimale */
            max-height: 160px;
            display: flex;
            flex-direction: column; /* Assurez-vous que la card soit en colonne */
        }

        /* Image du cours */
        .course-teacher {
            border-radius: 8px; /* Coins arrondis pour un rendu plus professionnel */
            border: 2px solid --primary-color; /* Contour de la photo pour un effet de finition */
        }

        /* Informations sur le cours */
        .course-info {
            border-top: 1px solid #66666673;
            padding: 10px;
            text-align: center;
            flex-grow: 1; /* Permet à la zone de texte d'occuper le reste de l'espace */
        }

        /* Progress bar */
        .progress-bar {
            background: #ddd;
            border-radius: 5px;
            height: 8px;
            margin: 10px 0;
            position: relative;
        }

        .progress {
            background: var(--primary-color);
            height: 100%;
            border-radius: 5px;
        }


        /* Section C : Crédits */
        .credits-section {
            flex: 1;
            text-align: center;
            background: #fff3e6;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid --primary-color;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .credits-section h3 {
            color: var(--primary-color);
            font-size: 1.5rem;
        }

        .credits-section .btn {
            margin-top: 10px;
        }

        .credit-amount {
            color: white; /* Définit la couleur du texte en blanc */
            font-weight: bold; /* Facultatif : met le nombre en gras pour plus de visibilité */
            text-shadow: 1px 1px 2px rgba(48, 43, 43, 0.500), -1px -1px 2px rgba(48, 43, 43, 0.500), 1px -1px 2px rgba(48, 43, 43, 0.500), -1px 1px 2px rgba(48, 43, 43, 0.500); /* Contour noir */
        }

        /* Section D : Actions */
        .actions {
            text-align: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #ddd;
        }

        .btn {
            display: inline-block;
            padding: 10px 20px;
            background-color: var(--primary-color);
            color: white;
            text-decoration: none;
            font-size: 1.1rem;
            border-radius: 5px;
            margin: 5px;
            transition: background 0.3s ease;
        }

        .btn:hover {
            background-color: #e55b00;
        }

        .btn-delete {
            background: red;
            border: none;
        }

        .btn-delete:hover {
            background: darkred;
        }
    </style>
</section>

<!-- Chart.js CDN (nécessaire) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  (function () {
    // Données depuis le serveur (EJS -> JSON)
    const courseLabels = <%- JSON.stringify(userCourses.map(c => c.name || 'Cours')) %>;
    const courseProgress = <%- JSON.stringify(userCourses.map(c => Number(c.progress || 0))) %>;

    // Si pas de cours, on montre un message friendly
    if (!courseLabels || courseLabels.length === 0) {
      document.getElementById('chart-stats').textContent = 'Vous n’êtes inscrit à aucun cours pour l’instant.';
      // cacher le canvas si pas de cours
      const canvas = document.getElementById('coursesChart');
      canvas.style.display = 'none';
      return;
    }

    // Calculs rapides (moyenne / meilleur cours)
    const sum = courseProgress.reduce((a,b) => a + b, 0);
    const avg = (courseProgress.length ? (sum / courseProgress.length).toFixed(1) : 0);
    const bestIndex = courseProgress.indexOf(Math.max(...courseProgress));
    const bestCourse = courseLabels[bestIndex] || '—';

    document.getElementById('chart-stats').innerHTML =
      `Moyenne : <strong>${avg}%</strong> </br> — Meilleure progression : <strong>${bestCourse} (${courseProgress[bestIndex]}%)</strong>`;

    // Setup chart (bar chart)
    const ctx = document.getElementById('coursesChart').getContext('2d');

    // Use CSS variable for primary color, fallback
    const rootStyle = getComputedStyle(document.documentElement);
    const primaryColor = rootStyle.getPropertyValue('--primary-color') || '#3751FF';
    const secondaryColor = rootStyle.getPropertyValue('--secondary-color') || '#232b4d';

    // Create gradient for bars (nice effect)
    const gradient = ctx.createLinearGradient(0, 0, 0, 200);
    try {
      gradient.addColorStop(0, primaryColor.trim());
      gradient.addColorStop(1, secondaryColor.trim());
    } catch (e) {
      // fallback simple color
      gradient.addColorStop(0, '#3751FF');
      gradient.addColorStop(1, '#232b4d');
    }

    // Destroy existing chart instance if any (safety for SPA)
    if (window.__coursesChartInstance) {
      try { window.__coursesChartInstance.destroy(); } catch(e) {}
      window.__coursesChartInstance = null;
    }

    window.__coursesChartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: courseLabels,
        datasets: [{
          label: 'Progression (%)',
          data: courseProgress,
          backgroundColor: gradient,
          borderRadius: 8,
          barThickness: 18,
          maxBarThickness: 34,
        }]
      },
      options: {
        maintainAspectRatio: false,
        responsive: true,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: function(context) {
                const v = context.parsed.y;
                return `Progression : ${v}%`;
              }
            }
          }
        },
        scales: {
          x: {
            ticks: {
              maxRotation: 45,
              minRotation: 0,
              autoSkip: false,
              callback: function(val, index) {
                // Tronque les labels longs (esthétique)
                const label = this.getLabelForValue(index);
                return label.length > 18 ? label.slice(0, 16) + '…' : label;
              }
            },
            grid: { display: false }
          },
          y: {
            beginAtZero: true,
            suggestedMax: 100,
            ticks: { callback: function(v) { return v + '%'; } },
            grid: { color: 'rgba(0,0,0,0.06)' }
          }
        },
        animation: {
          duration: 750,
          easing: 'easeOutQuart'
        }
      }
    });

    // Responsive height: set canvas height based on number of courses
    // (approx 48px per label + padding)
    const canvasEl = document.getElementById('coursesChart');
    const calcHeight = Math.max(200, courseLabels.length * 48);
    canvasEl.style.height = calcHeight + 'px';

    // Download PNG
    document.getElementById('downloadChart').addEventListener('click', function () {
      try {
        const url = canvasEl.toDataURL('image/png');
        const a = document.createElement('a');
        a.href = url;
        a.download = `performances_${(<%- JSON.stringify(user.username || 'user') %>)}.png`;
        document.body.appendChild(a);
        a.click();
        a.remove();
      } catch (e) {
        alert('Impossible de télécharger le graphique pour le moment.');
        console.error(e);
      }
    });
  })();
</script>
