<!-- views/partials/chat.ejs -->
<style>
  /* Chat bubble */
  #chat-toggle {
    position: fixed;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    width: 56px;
    height: 56px;
    background: var(--primary-color);
    border-radius: 50%;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 1000;
    transition: background 0.3s;
  }
  #chat-toggle:hover {
    background: var(--secondary-color);
  }
  #chat-toggle svg {
    width: 28px;
    height: 28px;
    fill: #fff;
  }

  /* Chat window */
  #chat-widget {
    position: fixed;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%) translateX(-100%);
    width: 320px;
    max-height: 480px;
    background: #fff;
    box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    border-radius: 12px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    font-family: var(--font-family);
    opacity: 0;
    visibility: hidden;
    transition: transform 0.3s ease, opacity 0.3s ease, visibility 0.3s;
    z-index: 1000;
  }
  #chat-widget.open {
    transform: translateY(-50%) translateX(0);
    opacity: 1;
    visibility: visible;
  }
  /* Close button */
  #chat-close {
    position: absolute;
    top: 8px;
    right: 8px;
    background: transparent;
    border: none;
    cursor: pointer;
    font-size: 1.2rem;
    color: #666;
    z-index: 1;
  }
  #chat-close:hover {
    color: #333;
  }
  /* Messages */
  #chat-messages .chat-msg { margin-bottom: 0.5rem; }
  #chat-messages .chat-msg .bubble {
    display: inline-block;
    padding: 0.5rem 0.75rem;
    border-radius: 8px;
    background: #f1f1f1;
    max-width: 80%;
  }
  #chat-messages .chat-msg.user .bubble {
    background: var(--primary-color);
    color: #fff;
    margin-left: auto;
  }
</style>

<!-- Toggle Button -->
<div id="chat-toggle" aria-label="Ouvrir le chat">
  <svg viewBox="0 0 24 24"><path d="M4 4h16v12H5.17L4 17.17V4z"/></svg>
</div>

<!-- Chat Window -->
<div id="chat-widget" role="dialog" aria-modal="true">
  <button id="chat-close" aria-label="Fermer le chat">×</button>
  <div id="chat-messages" style="flex:1; overflow-y:auto; padding:0.75rem;"></div>
  <div id="chat-input" style="border-top:1px solid #eee; padding:0.5rem; display:flex;">
    <input type="text" id="chat-text" placeholder="Posez votre question…" autocomplete="off"
           style="flex:1; padding:0.5rem; border:1px solid #ccc; border-radius:6px; font-size:0.9rem;"/>
    <button id="chat-send" style="margin-left:0.5rem; padding:0 1rem; border:none; background:var(--primary-color); color:#fff; border-radius:6px; cursor:pointer;">Envoyer</button>
  </div>
</div>

<script>
  (function() {
    const toggle = document.getElementById('chat-toggle');
    const widget = document.getElementById('chat-widget');
    const closeBtn = document.getElementById('chat-close');
    const messagesEl = document.getElementById('chat-messages');
    const inputEl = document.getElementById('chat-text');
    const btnEl = document.getElementById('chat-send');
    let history = [];

    toggle.addEventListener('click', () => {
      widget.classList.add('open');
    });
    closeBtn.addEventListener('click', () => {
      widget.classList.remove('open');
    });

    function addMessage(role, content) {
      const wrapper = document.createElement('div');
      wrapper.className = 'chat-msg ' + role;
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.textContent = content;
      wrapper.appendChild(bubble);
      messagesEl.appendChild(wrapper);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    async function send() {
      const question = inputEl.value.trim();
      if (!question) return;
      addMessage('user', question);
      inputEl.value = '';
      btnEl.disabled = true;

      let data;
      try {
        const res = await fetch('/chat/hugging', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ question, history })
        });
        console.log('Chat response status:', res.status);
        data = await res.json();
      } catch (err) {
        console.error('Network error:', err);
        addMessage('assistant', 'Erreur réseau, réessayez.');
        btnEl.disabled = false;
        return;
      }

      if (data.error) {
        console.error('API error:', data.error);
        addMessage('assistant', data.error);
      } else {
        const answer = data.answer;
        addMessage('assistant', answer);
        history.push({ role: 'user', content: question });
        history.push({ role: 'assistant', content: answer });
      }

      btnEl.disabled = false;
      inputEl.focus();
    }

    btnEl.addEventListener('click', send);
    inputEl.addEventListener('keydown', e => {
      if (e.key === 'Enter') send();
    });
  })();
</script>
